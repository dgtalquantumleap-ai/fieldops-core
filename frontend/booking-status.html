<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Check Booking Status - Stilt Heights</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üè†</text></svg>">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }
        .card {
            background: white;
            border-radius: 20px;
            padding: 40px 36px;
            width: 100%;
            max-width: 480px;
            box-shadow: 0 8px 40px rgba(0,0,0,0.15);
        }
        .logo {
            text-align: center;
            margin-bottom: 8px;
            font-size: 2rem;
        }
        h1 {
            text-align: center;
            font-size: 1.5rem;
            color: #1e293b;
            margin-bottom: 6px;
        }
        .subtitle {
            text-align: center;
            color: #64748b;
            font-size: 0.9rem;
            margin-bottom: 28px;
        }
        label {
            display: block;
            font-weight: 600;
            color: #374151;
            margin-bottom: 6px;
            font-size: 0.9rem;
        }
        .input-row {
            display: flex;
            gap: 10px;
        }
        input[type="text"] {
            flex: 1;
            padding: 12px 16px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            font-size: 1rem;
            font-family: inherit;
            text-transform: uppercase;
            letter-spacing: 1px;
            transition: border-color 0.2s;
        }
        input[type="text"]:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102,126,234,0.15);
        }
        input::placeholder { text-transform: none; letter-spacing: 0; color: #9ca3af; }
        button {
            padding: 12px 20px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 0.95rem;
            font-weight: 600;
            cursor: pointer;
            white-space: nowrap;
            transition: opacity 0.2s;
        }
        button:disabled { opacity: 0.6; cursor: not-allowed; }
        .hint { font-size: 0.8rem; color: #9ca3af; margin-top: 6px; }
        .error {
            margin-top: 16px;
            padding: 12px 16px;
            background: #fef2f2;
            border: 1px solid #fecaca;
            border-radius: 8px;
            color: #dc2626;
            font-size: 0.9rem;
            display: none;
        }
        /* Status result card */
        .result {
            margin-top: 24px;
            border: 1px solid #e5e7eb;
            border-radius: 12px;
            overflow: hidden;
            display: none;
        }
        .result-header {
            padding: 14px 20px;
            font-weight: 700;
            font-size: 0.85rem;
            letter-spacing: 0.5px;
            text-transform: uppercase;
        }
        .result-body { padding: 20px; display: grid; gap: 12px; }
        .row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 12px;
        }
        .row .label { color: #64748b; font-size: 0.9rem; font-weight: 500; }
        .row .value { font-weight: 600; font-size: 0.95rem; text-align: right; }
        .ref { font-size: 1.1rem; color: #7c3aed; font-weight: 800; letter-spacing: 1px; }
        /* Status badges */
        .badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 99px;
            font-size: 0.8rem;
            font-weight: 700;
        }
        .badge-scheduled  { background: #dbeafe; color: #1d4ed8; }
        .badge-in-progress { background: #fef3c7; color: #d97706; }
        .badge-completed  { background: #d1fae5; color: #059669; }
        .badge-cancelled  { background: #f3f4f6; color: #6b7280; }

        .back-link {
            display: block;
            text-align: center;
            margin-top: 24px;
            color: #667eea;
            text-decoration: none;
            font-size: 0.9rem;
            font-weight: 500;
        }
        .back-link:hover { text-decoration: underline; }

        @media (max-width: 480px) {
            .card { padding: 28px 20px; }
        }
    </style>
</head>
<body>
    <div class="card">
        <div class="logo">üè†</div>
        <h1>Check Booking Status</h1>
        <p class="subtitle">Enter your booking reference to see the current status</p>

        <label for="refInput">Booking Reference</label>
        <div class="input-row">
            <input type="text" id="refInput" placeholder="JOB-0001" maxlength="12" autocomplete="off">
            <button id="lookupBtn" onclick="lookupStatus()">Check</button>
        </div>
        <p class="hint">Your reference number was on your booking confirmation (e.g. JOB-0001)</p>

        <div class="error" id="errorMsg"></div>

        <div class="result" id="resultCard">
            <div class="result-header" id="resultHeader"></div>
            <div class="result-body" id="resultBody"></div>
        </div>

        <a href="/booking.html" class="back-link">‚Üê Book a new appointment</a>
    </div>

    <script>
        // Auto-format input as JOB-XXXX
        document.getElementById('refInput').addEventListener('input', function () {
            let v = this.value.toUpperCase().replace(/[^A-Z0-9]/g, '');
            if (v.startsWith('JOB')) {
                const digits = v.slice(3).replace(/\D/g, '').slice(0, 4);
                this.value = digits.length ? 'JOB-' + digits : 'JOB-';
            } else {
                this.value = v;
            }
        });

        document.getElementById('refInput').addEventListener('keydown', (e) => {
            if (e.key === 'Enter') lookupStatus();
        });

        async function lookupStatus() {
            const ref = document.getElementById('refInput').value.trim().toUpperCase();
            const errorEl = document.getElementById('errorMsg');
            const resultCard = document.getElementById('resultCard');
            const btn = document.getElementById('lookupBtn');

            errorEl.style.display = 'none';
            resultCard.style.display = 'none';

            if (!ref || !/^JOB-\d{1,4}$/.test(ref)) {
                errorEl.textContent = 'Please enter a valid reference like JOB-0001';
                errorEl.style.display = 'block';
                return;
            }

            btn.disabled = true;
            btn.textContent = 'Looking up...';

            try {
                const res = await fetch(`/api/booking/status/${encodeURIComponent(ref)}`);
                const result = await res.json();

                if (!result.success) {
                    errorEl.textContent = result.error || 'Booking not found. Check the reference number and try again.';
                    errorEl.style.display = 'block';
                    return;
                }

                showResult(result.data);
            } catch (err) {
                errorEl.textContent = 'Could not connect. Please try again or call 825-994-6606.';
                errorEl.style.display = 'block';
            } finally {
                btn.disabled = false;
                btn.textContent = 'Check';
            }
        }

        function showResult(d) {
            const statusMap = {
                'Scheduled':   { label: 'Scheduled',    cls: 'badge-scheduled' },
                'In Progress': { label: 'In Progress',  cls: 'badge-in-progress' },
                'Completed':   { label: 'Completed',    cls: 'badge-completed' },
                'Cancelled':   { label: 'Cancelled',    cls: 'badge-cancelled' }
            };
            const s = statusMap[d.status] || { label: d.status, cls: 'badge-scheduled' };

            const headerColors = {
                'Scheduled':   'background:#dbeafe; color:#1d4ed8',
                'In Progress': 'background:#fef3c7; color:#d97706',
                'Completed':   'background:#d1fae5; color:#059669',
                'Cancelled':   'background:#f3f4f6; color:#6b7280'
            };

            const hdr = document.getElementById('resultHeader');
            hdr.style.cssText = headerColors[d.status] || '';
            hdr.textContent = `Booking ${d.reference}`;

            const dateStr = d.date
                ? new Date(d.date + 'T00:00:00').toLocaleDateString('en-US', {
                      weekday: 'long', year: 'numeric', month: 'long', day: 'numeric'
                  })
                : '‚Äî';

            const timeStr = d.time
                ? new Date(`2000-01-01T${d.time}:00`).toLocaleTimeString('en-US', {
                      hour: 'numeric', minute: '2-digit', hour12: true
                  })
                : '‚Äî';

            document.getElementById('resultBody').innerHTML = `
                <div class="row">
                    <span class="label">Reference</span>
                    <span class="value ref">${esc(d.reference)}</span>
                </div>
                <div class="row">
                    <span class="label">Status</span>
                    <span class="badge ${s.cls}">${s.label}</span>
                </div>
                <div class="row">
                    <span class="label">Service</span>
                    <span class="value">${esc(d.service)}</span>
                </div>
                <div class="row">
                    <span class="label">Date</span>
                    <span class="value">${dateStr}</span>
                </div>
                <div class="row">
                    <span class="label">Arrival Window</span>
                    <span class="value">${timeStr}</span>
                </div>
                <div class="row">
                    <span class="label">Assigned Cleaner</span>
                    <span class="value">${esc(d.assignedStaff)}</span>
                </div>
            `;

            document.getElementById('resultCard').style.display = 'block';
        }

        function esc(str) {
            return String(str || '').replace(/[&<>"']/g, m =>
                ({ '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#039;' }[m])
            );
        }

        // Pre-fill from URL ?ref=JOB-0001
        const urlRef = new URLSearchParams(window.location.search).get('ref');
        if (urlRef) {
            document.getElementById('refInput').value = urlRef.toUpperCase();
            lookupStatus();
        }
    </script>
</body>
</html>
